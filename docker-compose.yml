version: '3.8'

services:
  binance-bot:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: binance-trading-bot
    restart: unless-stopped

    environment:
      # Binance API Configuration
      - BINANCE_API_KEY=${BINANCE_API_KEY}
      - BINANCE_API_SECRET=${BINANCE_API_SECRET}
      - BINANCE_TESTNET_API_KEY=${BINANCE_TESTNET_API_KEY}
      - BINANCE_TESTNET_API_SECRET=${BINANCE_TESTNET_API_SECRET}
      - TRADING_MODE=${TRADING_MODE:-paper}  # paper or live
      - NUMBA_DISABLE_JIT=1  # Fix for pandas_ta numba caching issue
      - LOG_TO_FILE=false  # Use docker logs instead of file logging

      # Trading Configuration
      - TRADING_PAIRS=${TRADING_PAIRS:-BTCUSDT,ETHUSDT,BNBUSDT,SOLUSDT}
      - MAX_DAILY_LOSS=${MAX_DAILY_LOSS:-10}
      - INITIAL_BALANCE=${INITIAL_BALANCE:-350}
      - RISK_PER_TRADE=${RISK_PER_TRADE:-0.02}
      - MAX_PORTFOLIO_RISK=${MAX_PORTFOLIO_RISK:-0.15}

      # Strategy Configuration
      - ENABLE_MOMENTUM_STRATEGY=${ENABLE_MOMENTUM_STRATEGY:-true}
      - ENABLE_MEAN_REVERSION=${ENABLE_MEAN_REVERSION:-false}
      - MOMENTUM_ALLOCATION=${MOMENTUM_ALLOCATION:-0.3}
      - MOMENTUM_THRESHOLD=${MOMENTUM_THRESHOLD:-0.75}
      - VOLUME_THRESHOLD=${VOLUME_THRESHOLD:-2.0}

      # Risk Management
      - ATR_STOP_MULTIPLIER=${ATR_STOP_MULTIPLIER:-2.5}
      - TRAILING_STOP_PERCENT=${TRAILING_STOP_PERCENT:-5}

      # Technical Indicators
      - RSI_OVERSOLD=${RSI_OVERSOLD:-30}
      - RSI_OVERBOUGHT=${RSI_OVERBOUGHT:-70}
      - EMA_FAST=${EMA_FAST:-20}
      - EMA_SLOW=${EMA_SLOW:-50}
      - EMA_TREND=${EMA_TREND:-200}

      # Telegram Configuration
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN}
      - TELEGRAM_CHAT_ID=${TELEGRAM_CHAT_ID}
      - ENABLE_TELEGRAM=${ENABLE_TELEGRAM:-true}

      # Logging
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - PYTHONUNBUFFERED=1

      # Timezone
      - TZ=Europe/London

    volumes:
      # Persist logs and data
      - ./logs:/app/logs
      - ./data:/app/data

    networks:
      - trading-network

    # Resource limits (adjust based on VPS specs)
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 128M

    # Logging configuration
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "5"

    # Health check
    healthcheck:
      test: ["CMD", "python", "-c", "import os; exit(0 if os.path.exists('data/bot.lock') else 1)"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 30s

networks:
  trading-network:
    driver: bridge
